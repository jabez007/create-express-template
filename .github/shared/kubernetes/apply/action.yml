name: Apply Kubernetes Manifests to Cluster
description: ''

inputs:
  dry_run:
    description: ''
    default: 'true'
  debug:
    description: Whether or not to display debug output
    default: "false"

runs:
  using: composite
  steps:
    - name: Test kubectl access
      if: ${{ inputs.debug == 'true' }}
      run: kubectl get pods
      shell: bash

    ####

    - name: Apply all manifests
      run: |
        for file in k8s/*.yaml k8s/*.yml; do
          kubectl apply -f $file ${{ inputs.dry_run == 'true' && '--dry-run=client' || '' }}
        done
      shell: bash

    ####

    - name: Describe resources
      if: ${{ inputs.debug == 'true' && inputs.dry_run != 'true' }}
      run: |
        for file in k8s/*.yaml k8s/*.yml; do
          kind=$(yq -r .kind $file)
          name=$(yq -r .metadata.name $file)
          kubectl describe $kind $name
        done
      shell: bash

    ####

    - name: Check deployment rollout status
      if: ${{ (hashFiles('k8s/deployment.yaml') != '' || hashFiles('k8s/deployment.yml') != '') && inputs.dry_run != 'true' }}
      run: kubectl rollout status deploy $(yq -r .metadata.name k8s/deployment.yaml)
      shell: bash

    ####